@page "/admin/login"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using System.Security.Claims
@using System.Text.Json
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@* Changed from InteractiveServer to static to allow HttpContext access *@
@* @rendermode InteractiveServer *@

<PageTitle>Admin Login - Restaurant Admin</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <i class="bi bi-shield-lock-fill"></i>
            <h2>Restaurant Admin</h2>
            <p>Sign in to access the dashboard</p>
        </div>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                @ErrorMessage
            </div>
        }

        <EditForm Model="Model" OnValidSubmit="HandleLogin" class="login-form" FormName="LoginForm">
            <DataAnnotationsValidator />
            
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-envelope"></i>
                    Email Address
                </label>
                <InputText @bind-Value="Model.Email" class="form-control" placeholder="admin@restaurant.com" />
                <ValidationMessage For="@(() => Model.Email)" />
            </div>
 
            <div class="form-group">
                <label class="form-label">
                    <i class="bi bi-key"></i>
                    Password
                </label>
                <InputText type="password" @bind-Value="Model.Password" class="form-control" placeholder="Enter your password" />
                <ValidationMessage For="@(() => Model.Password)" />
            </div>
 
            <div class="form-check mb-3">
                <InputCheckbox @bind-Value="Model.RememberMe" class="form-check-input" id="rememberMe" />
                <label class="form-check-label" for="rememberMe">
                    Remember me
                </label>
            </div>
 
            <button type="submit" class="btn btn-primary w-100" disabled="@IsLoading">
                @if (IsLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign In</span>
                }
            </button>
        </EditForm>
 
        <div class="login-footer">
        </div>
    </div>
</div>
 
<style>
    .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem;
    }

    .login-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        width: 100%;
        max-width: 420px;
        padding: 2.5rem;
    }

    .login-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .login-header i {
        font-size: 4rem;
        color: #667eea;
        margin-bottom: 1rem;
    }

    .login-header h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #1a202c;
    }

    .login-header p {
        color: #718096;
        margin: 0;
    }

    .login-form {
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1a202c;
    }

    .form-label i {
        color: #667eea;
    }

    .form-control {
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        padding: 0.875rem 1.5rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:disabled {
        opacity: 0.7;
        transform: none;
    }

    .alert {
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .login-footer {
        text-align: center;
        padding-top: 1.5rem;
        border-top: 1px solid #e2e8f0;
    }

    .login-footer p {
        font-size: 0.85rem;
        margin: 0;
    }

    .validation-message {
        color: #e53e3e;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
 
@code {
    [SupplyParameterFromForm]
    private LoginDto Model { get; set; } = new();
    
    private bool IsLoading { get; set; } = false;
    private string? ErrorMessage { get; set; }
 
    private async Task HandleLogin()
    {
        IsLoading = true;
        ErrorMessage = null;
 
        try
        {
            // Try API authentication first
            var httpClient = HttpClientFactory.CreateClient("RestaurantAPI");
            var loginRequest = new { email = Model.Email, password = Model.Password };
            
            var response = await httpClient.PostAsJsonAsync("/api/auth/login", loginRequest);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<JsonElement>();
                
                // Check if login was successful
                if (result.TryGetProperty("success", out var success) && success.GetBoolean())
                {
                    // Get user data from response
                    var data = result.GetProperty("data");
                    var email = data.TryGetProperty("email", out var emailProp) ? emailProp.GetString() : Model.Email;
                    var fullName = data.TryGetProperty("fullName", out var nameProp) ? nameProp.GetString() : "Admin User";
                    var role = data.TryGetProperty("role", out var roleProp) ? roleProp.GetString() : "Admin";
                    var userId = data.TryGetProperty("userId", out var userIdProp) ? userIdProp.GetInt32().ToString() : "1";
                    var token = data.TryGetProperty("token", out var tokenProp) ? tokenProp.GetString() : "";
                    
                    await SignInAsync(fullName ?? "Admin User", email ?? Model.Email, role ?? "Admin", userId, token);
                    return;
                }
            }
            
#if DEBUG
            // Fallback to hardcoded credentials only in Debug mode
            if (Model.Email == "admin@restaurant.com" && Model.Password == "Admin@123")
            {
                await SignInAsync("Admin User", Model.Email, "Admin", "1", "");
                return;
            }
#endif
            
            ErrorMessage = "Invalid email or password. Please try again.";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Login error: {ex.Message}");
            ErrorMessage = "An error occurred during login. Please ensure the API is running and try again.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SignInAsync(string name, string email, string role, string userId, string token)
    {
        var claims = new List<Claim>
        {
            new Claim(ClaimTypes.Name, name),
            new Claim(ClaimTypes.Email, email),
            new Claim(ClaimTypes.Role, role),
            new Claim("UserId", userId),
            new Claim("AuthToken", token)
        };

        var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        var principal = new ClaimsPrincipal(identity);

        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext != null)
        {
            await httpContext.SignInAsync(
                CookieAuthenticationDefaults.AuthenticationScheme, 
                principal, 
                new AuthenticationProperties { IsPersistent = Model.RememberMe });
            
            Navigation.NavigateTo("/admin", forceLoad: true);
        }
    }

    private class LoginDto
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password is required")]
        [System.ComponentModel.DataAnnotations.MinLength(12, ErrorMessage = "Password must be at least 12 characters")]
        public string Password { get; set; } = "";

        public bool RememberMe { get; set; }
    }
}
